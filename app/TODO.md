# Права доступа

Напротив каждой книги в зависимости от роли текущего пользователя должны отображаться кнопки (значки) для просмотра
данных о книге, редактирования, удаления.

Кнопка «Просмотр» должна быть доступна всем пользователям. Кнопка «Редактирование» – только пользователям с ролями
«Администратор» и «Модератор». Кнопка «Удалить» – только пользователям с ролью «Администратор».

Под списком книг для пользователей с ролью «Администратор» должна отображаться кнопка «Добавить книгу».

Если пользователь не аутентифицирован, то при попытке доступа к странице, недоступной неаутентифицированным
пользователям, он должен быть перенаправлен на страницу входа с сообщением «Для выполнения данного действия необходимо
пройти процедуру аутентификации».

В случае, если пользователь попробует произвести действие, для выполнения которого у него недостаточно прав (например,
введёт в адресной страке адрес страницы добавления книги), то он должен быть перенаправлен на главную страницу с
сообщением «У вас недостаточно прав для выполнения данного действия».

# Удаление записей

По нажатию на кнопку «Удалить» должно открываться модальное окно с заголовком «Удаление книги». В модальном окне должно
быть сообщение «Вы уверены, что хотите удалить книгу {название книги}?» и кнопки «Да» и «Нет». По нажатию на кнопку
«Нет» происходит закрытие модального окна, а по нажатию на кнопку «Да» отправляется запрос на сервер для удаления записи
из базы. После обработки запроса пользователь должен быть перенаправлен на главную страницу, на которой должно
отобразиться сообщение об успешном удалении записи (flash-сообщение). При удалении книги должны удаляться все связанные
с ней записи (обложка, рецензии, записи из соединительной таблицы книги-жанры). Для этого нужно при создании
соответствующих внешних ключей прописать ON DELETE CASCADE и не забыть удалить из файловой системы файл, соответствующий
обложке удаляемой книги.

# Страница добавления/редактирования книги

На страницах добавления и редактирования книги должна располагаться форма ввода данных о книге. Она должна содержать
набор полей, соответствующих полям таблицы с книгами. Так как набор полей у форм добавления и редактирования практически
совпадает, для их реализации должен быть использован макрос. Единственное отличие форм создания и редакирования – это
отсутствие поля для загрузки файла с обложкой на странице редактирования. Предполагается, что обложка загружается при
создании записи и не подлежит редактированию.

На форме для добавления книги должно быть отдельное поле для загрузки файла с обложкой.

# Замечание

Для передачи файлов на сервер не забудьте проставить атрибут enctype="multipart/form-data" у тега формы!
В поле с описанием книги должна быть возможность использовать язык разметки Markdown. Рекомендуется для реализации этого
поля использовать тег textarea и библиотеку EasyMDE, добавляющую к текстовому полю дополнительные элементы управления,
облегчающие форматирование текста.

Для реализации поля «Жанр» рекомендуется использовать тег select с проставленным атрибутом multiple (мультиселект).

Перед сохранением описания книги необходимо «прогнать» введённое пользователем значение через санитайзер (например,
Bleach), чтобы экранировать все потенциально опасные теги (например, скрипты), которые мог ввести пользователь.

При нажатии на кнопку «Сохранить», на сервер должен быть отправлен запрос для сохранения данных. В случае, если при
сохранении данных возникла ошибка, пользователю должна отобразиться форма с введёнными данными и сообщение «При
сохранении данных возникла ошибка. Проверьте корректность введённых данных.». В случае успешного сохранения пользователь
должен быть перенаправлен на страницу просмотра данных о книге.

Если в транзакции присутствует более одного запроса, то ошибка может возникнуть при выполнении любого из них. В этом
случае необходимо позаботиться о том, чтобы откатить изменения, которые уже были внесены в базу в рамках текущей
транзакции (т. е. до возникновения ошибки). Для этого в блоке except нужно выполнить mysql.connection.rollback() (если
вы используете mysql-connector-python) или db.session.rollback() (если вы используете SQLAlchemy).

Для предотвращения дублирования файлов при сохранении изображения необходимо вычислить его MD5-хэш. Перед тем как
добавлять новую запись в таблицу с изображениями, необходимо проверить, нет ли в ней записи с таким же значением хэша,
как для текущего изображения. Если такая запись найдена, значит это изображение уже было загружено ранее, и нет
необходимости заново его сохранять -- можно взять идентификатор найденной записи. В противном случае необходимо добавить
новую запись в таблицу и сохранить файл в файловой системе. В качестве названия файла рекомендуется использовать
идентификатор записи в таблице с изображениями (так как пользовательские названия файлов могут совпадать для разных
файлов).

# Замечание

   Необходимо учитывать, что сохранение книги нужно выполнить перед сохранением обложки, так как при сохранении обложки
нужно указать идентификатор книги. Для того, чтобы получить этот идентификатор, можно воспользоваться свойством
lastrowid объекта cursor (подробнее см. в документации).

Сохранение файла с обложкой в файловую систему лучше производить после того, как будут добавлены записи в таблицы с
изображениями и книгами, так как в таком случае не придётся удалять файл в случае возникновения ошибки при добавлении
записей в СУБД.

Если при загрузке файла с обложкой ваше приложение падает с ошибкой, посмотрите логи веб-сервера с помощью команды sudo
tail -f /opt/unit/unit.log. Если вы увидите ошибку [alert] ... mkstemp(/opt/unit/tmp/...) failed (2: No such file or
directory), нужно создать директорию для хранения временных файлов sudo mkdir /opt/unit/tmp, а затем изменить права
доступа к этой директории sudo chmod -R a=rwx,o+t /opt/unit/tmp. Последняя команда также должна помочь, если у вас
возникает ошибка [alert] ... mkstemp(/opt/unit/tmp/...) failed (13: Permission denied).

# Страница просмотра данных о книге

На странице просмотра должна отображаться обложка книги, а также все данные о книге. Описание книги должно быть
преобразовано из Markdown в HTML и подставлено на страницу. Формат отображения на усмотрения студента.

Внизу страницы должны быть отображены все рецензии, оставленные пользователями к этой книге. Для каждой рецензии должен
быть указан пользователь, который её оставил, оценка и текст рецензии (с учётом форматирования).

# Функциональность создания рецензий

Если пользователь аутентифицирован, имеет роль «Пользователь», «Модератор» или «Администратор», и не писал ранее
рецензию на данную книгу, то для него внизу страницы должна отображаться кнопка «Написать рецензию». Если он уже писал
рецензию на данную книгу, то вместо кнопки ему должна быть отображена его рецензия. Пользователь не может написать более
одной рецензии на конкретную книгу.

По нажатию на кнопку «Написать рецензию» пользователь должен попасть на страницу с формой для создания рецензии. В ней
должны быть поля «Оценка» и «Текст рецензии».

Поле оценки представляет собой селектор с опциями

* 5 – отлично (значение по умолчанию),
* 4 – хорошо,
* 3 – удовлетворительно,
* 2 – неудовлетворительно,
* 1 – плохо,
* 0 – ужасно.

Пользователю должны отображаться только названия оценок, а на сервер должны передаваться только числовые значения.

Поле «Текст рецензии» должно представлять с собой тег textarea. В тексте рецензии должна быть реализована поддержка
языка форматирования Markdown.

По нажатию на кнопку «Сохранить», если сохранение выполнено успешно, пользователь должен быть перенаправлен на страницу
просмотра книги. В противном случае ему должно быть отображено сообщение об ошибке, и он должен остаться на странице с
формой создания рецензии.

При сохраненни текста рецензии необходимо не забыть «пропустить» его через санитайзер.